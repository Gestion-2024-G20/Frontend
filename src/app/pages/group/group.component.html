<div class="container">
    <div class="content">
        <section class="header-section">
            <h2 class="title"> {{ this.group.name }}</h2>
            <button *ngIf="!this.isAdmin" class="btn btn-danger" (click)="leaveGroup()">Abandonar grupo</button>
        </section>
        <p> {{ this.group.description }}</p>
        <section  *ngIf="this.balancesUserLogged.to_pay.length > 0 || this.balancesUserLogged.to_receive.length > 0" class="balances">
            @for (balance of this.balancesUserLogged.to_pay; track $index) {
                <span > le debes a {{ balance.username }}: </span><p class="text-danger">${{balance.amount}}</p>
            }
            @for (balance of this.balancesUserLogged.to_receive; track $index) {
                <span > {{ balance.username }} te debe: </span><p class="text-success">${{balance.amount}}</p>
            }
            <h6> TOTAL A PAGAR {{this.totalToPay}} </h6>
            <h6> TOTAL A RECIBIR {{this.totalToReceive}} </h6>
        </section>
        <mat-accordion multi>
        <mat-expansion-panel  *ngIf="this.balances.length > 0">
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        <h5><i class="fa fa-users" aria-hidden="true"></i> SALDOS</h5>
                    </mat-panel-title>
                </mat-expansion-panel-header>
                <div class="p-3 bg-primary-subtle text-primary-emphasis rounded">
                    @for (member of this.totalmembers;track $index) {
                        <h6> SALDO {{member.username}} </h6>
                        @for (b of this.balances[$index].to_pay; track b.id_user) {
                            <span > {{member.username}} le debe a {{ b.username }}: </span><p class="text-danger">${{b.amount}}</p>
                        }
                        @for (b of this.balances[$index].to_receive; track b.id_user) {
                            <span > {{ b.username }} le debe a {{member.username}} : </span><p class="text-success">${{b.amount}}</p>
                        }
                    }
                </div>
            </mat-expansion-panel>
            <mat-expansion-panel>
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        <h5><i class="fa fa-users" aria-hidden="true"></i> MIEMBROS</h5>
                    </mat-panel-title>
                </mat-expansion-panel-header>
                <div class="p-3 bg-primary-subtle text-primary-emphasis rounded">
                    <table mat-table [dataSource]="dataSourceMembers" class="mat-elevation-z8">
                        <!-- Username Column -->
                        <ng-container matColumnDef="username">
                            <th mat-header-cell *matHeaderCellDef> Username </th>
                            <td mat-cell *matCellDef="let element">
                                <img
                                    *ngIf="element.profilePhoto_filename"
                                    [src]="'/assets/images/' + element.profilePhoto_filename"
                                    class="avatar-img"
                                    alt="Avatar"
                                    style="width:30px;height:30px;"
                                />
                                <mat-icon *ngIf="!element.profilePhoto_filename">person</mat-icon>
                                {{element.username}}</td>
                        </ng-container>
                    

                        <!-- Tipo Column -->
                        <ng-container matColumnDef="type">
                            <th mat-header-cell *matHeaderCellDef> Tipo </th>
                            <td mat-cell *matCellDef="let element" [class.make-gold]='element.type == "admin"'>
                                {{element.type}} </td>
                        </ng-container>

                        <!-- Actions Column -->
                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef> Acciones </th>
                            <td mat-cell *matCellDef="let element" [class.make-gold]='element.type == "admin"'>
                                <button *ngIf="loggedUserId != element.id_user && isAdmin" type="button"
                                    class="btn btn-danger" (click)="deleteUser(element.id_user)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumnsMembers"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumnsMembers;"></tr>
                    </table>
                    <section class="buttons">
                        @if (this.isAdmin){
                            <button class="btn btn-primary" type="button" (click)="createRequestUrl()"><mat-icon>link</mat-icon>Obtener link de invitación</button>
                            <button class="btn btn-primary" type="button" (click)="addUser()">Invitar usuario</button>
                            <button class="btn btn-primary" type="button" (click)="listadoInvitados()">Ver invitados</button>
                            <button class="btn btn-primary" type="button" (click)="listadoSolicitudes()">Ver solicitudes</button>
                        }
                    </section>
                    @if (this.isAdmin && invitationUrl){
                        Copy link to invite members: {{this.invitationUrl}}
                    }
                </div>
            </mat-expansion-panel>

            <mat-expansion-panel>
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        <h5><i class="fa fa-list"> </i>CATEGORIAS</h5>
                    </mat-panel-title>
                </mat-expansion-panel-header>
                <div class="p-3 bg-primary-subtle text-primary-emphasis rounded">
                    <section class="buttons">
                        <button *ngIf="this.isAdmin" class="btn btn-primary" type="button" (click)="createCategory()">Crear categoría</button>
                    </section>
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col"> Titulo</th>
                                <th scope="col"><mat-icon>description</mat-icon> Descripción</th>
                                <th scope="col">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (category of this.categories; track $index) {

                            <tr>
                                <td scope="row">{{$index + 1}}</td>
                                <td>{{category.name}}</td>
                                <td>{{category.description}}</td>
                                <td class="buttons">
                                    <button type="button" class="btn btn-primary firstButton"
                                        (click)="detailCategory(category)">Detalle</button>
                                    <button *ngIf="this.isAdmin" type="button" class="btn btn-danger"
                                        (click)="deleteCategory(category)">Eliminar categoría</button>
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </mat-expansion-panel>

            <mat-expansion-panel expanded>
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        <h5><i class="fa fa-dollar-sign"></i> GASTOS</h5>
                    </mat-panel-title>
                </mat-expansion-panel-header>
                <div class="p-3 bg-primary-subtle text-primary-emphasis rounded">
                    <section class="buttons">
                        <button class="btn btn-primary" type="button" (click)="filterExpenditures()">Filtrar gastos</button>
                        <button class="btn btn-primary" type="button" (click)="createExpenditure()">Añadir Gasto</button>
                    </section>
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">User Id</th>
                                <th scope="col">Descripción</th>
                                <th scope="col">Cantidad</th>
                                <th scope="col" *ngIf="this.isAdmin">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (e of this.expenditures; track $index) {

                            <tr>
                            <td scope="row">{{$index + 1}}</td>
                            <td>{{e.id_user}}</td>
                            <td>{{e.description}}</td>
                            <td>{{e.amount}}</td>
                            <td *ngIf="this.isAdmin" class="buttons">
                                <button type="button" class="btn btn-primary" (click)="updateExpenditure(e)">Editar Gasto</button>
                                <button type="button" class="btn btn-danger" (click)="deleteExpenditure(e)">Eliminar Gasto</button>
                            </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </mat-expansion-panel>
        </mat-accordion>


    </div>
</div>